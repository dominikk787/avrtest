/*
 * n5110_lib.c
 *
 * Created: 2019-06-08 16:29:05
 * Author : programowanie
 */ 

#include <avr/io.h>
#include <util/delay.h>
#include <avr/pgmspace.h>
#include "lcd.h"

uint8_t lcd_buf[84][6];

const uint8_t font[] PROGMEM = {
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x5f,0x00,0x00,0x00,0x00,0x07,0x00,0x07,
	0x00,0x00,0x14,0x7f,0x14,0x7f,0x14,0x00,0x24,0x2a,0x7f,0x2a,0x12,0x00,0x23,0x13,
	0x08,0x64,0x62,0x00,0x36,0x49,0x55,0x22,0x50,0x00,0x00,0x00,0x03,0x00,0x00,0x00,
	0x00,0x1c,0x22,0x41,0x00,0x00,0x00,0x41,0x22,0x1c,0x00,0x00,0x14,0x08,0x3e,0x08,
	0x14,0x00,0x08,0x08,0x3e,0x08,0x08,0x00,0x00,0x50,0x30,0x00,0x00,0x00,0x08,0x08,
	0x08,0x08,0x08,0x00,0x00,0x60,0x60,0x00,0x00,0x00,0x20,0x10,0x08,0x04,0x02,0x00,
	0x3e,0x51,0x49,0x45,0x3e,0x00,0x00,0x42,0x7f,0x40,0x00,0x00,0x42,0x61,0x51,0x49,
	0x46,0x00,0x21,0x41,0x45,0x4b,0x31,0x00,0x18,0x14,0x12,0x7f,0x10,0x00,0x27,0x45,
	0x45,0x45,0x39,0x00,0x3c,0x4a,0x49,0x49,0x30,0x00,0x03,0x71,0x09,0x05,0x03,0x00,
	0x36,0x49,0x49,0x49,0x36,0x00,0x06,0x49,0x49,0x29,0x1e,0x00,0x00,0x36,0x36,0x00,
	0x00,0x00,0x00,0x56,0x36,0x00,0x00,0x00,0x08,0x14,0x22,0x41,0x00,0x00,0x14,0x14,
	0x14,0x14,0x14,0x00,0x00,0x41,0x22,0x14,0x08,0x00,0x02,0x01,0x51,0x09,0x06,0x00,
	0x32,0x49,0x79,0x41,0x3e,0x00,0x7e,0x11,0x11,0x11,0x7e,0x00,0x7f,0x49,0x49,0x49,
	0x36,0x00,0x3e,0x41,0x41,0x41,0x22,0x00,0x7f,0x41,0x41,0x41,0x3e,0x00,0x7f,0x49,
	0x49,0x49,0x41,0x00,0x7f,0x09,0x09,0x09,0x01,0x00,0x3e,0x41,0x41,0x49,0x7a,0x00,
	0x7f,0x08,0x08,0x08,0x7f,0x00,0x00,0x41,0x7f,0x41,0x00,0x00,0x20,0x40,0x41,0x3f,
	0x01,0x00,0x7f,0x08,0x14,0x22,0x41,0x00,0x7f,0x40,0x40,0x40,0x40,0x00,0x7f,0x02,
	0x0c,0x02,0x7f,0x00,0x7f,0x04,0x08,0x10,0x7f,0x00,0x3e,0x41,0x41,0x41,0x3e,0x00,
	0x7f,0x09,0x09,0x09,0x06,0x00,0x3e,0x41,0x51,0x21,0x5e,0x00,0x7f,0x09,0x19,0x29,
	0x46,0x00,0x46,0x49,0x49,0x49,0x31,0x00,0x01,0x01,0x7f,0x01,0x01,0x00,0x3f,0x40,
	0x40,0x40,0x3f,0x00,0x1f,0x20,0x40,0x20,0x1f,0x00,0x3f,0x40,0x38,0x40,0x3f,0x00,
	0x63,0x14,0x08,0x14,0x63,0x00,0x07,0x08,0x70,0x08,0x07,0x00,0x61,0x51,0x49,0x45,
	0x43,0x00,0x00,0x7f,0x41,0x41,0x00,0x00,0x02,0x04,0x08,0x10,0x20,0x00,0x00,0x41,
	0x41,0x7f,0x00,0x00,0x04,0x02,0x01,0x02,0x04,0x00,0x40,0x40,0x40,0x40,0x40,0x00,
	0x00,0x01,0x02,0x04,0x00,0x00,0x20,0x54,0x54,0x54,0x78,0x00,0x7f,0x48,0x44,0x44,
	0x38,0x00,0x38,0x44,0x44,0x44,0x20,0x00,0x38,0x44,0x44,0x48,0x7f,0x00,0x38,0x54,
	0x54,0x54,0x18,0x00,0x08,0x7e,0x09,0x01,0x02,0x00,0x18,0xa4,0xa4,0xa4,0x7c,0x00,
	0x7f,0x08,0x04,0x04,0x78,0x00,0x00,0x48,0x7d,0x40,0x00,0x00,0x00,0x00,0x84,0x7d,
	0x00,0x00,0x7f,0x10,0x28,0x44,0x00,0x00,0x00,0x41,0x7f,0x40,0x00,0x00,0x7c,0x04,
	0x78,0x04,0x78,0x00,0x7c,0x08,0x04,0x04,0x78,0x00,0x38,0x44,0x44,0x44,0x38,0x00,
	0xfc,0x24,0x24,0x24,0x18,0x00,0x18,0x24,0x24,0x28,0xfc,0x00,0x7c,0x08,0x04,0x04,
	0x08,0x00,0x48,0x54,0x54,0x54,0x20,0x00,0x04,0x3f,0x44,0x40,0x20,0x00,0x3c,0x40,
	0x40,0x20,0x7c,0x00,0x1c,0x20,0x40,0x20,0x1c,0x00,0x3c,0x40,0x30,0x40,0x3c,0x00,
	0x44,0x28,0x10,0x28,0x44,0x00,0x1c,0xa0,0xa0,0xa0,0x7c,0x00,0x44,0x64,0x54,0x4c,
	0x44,0x00,0x00,0x08,0x36,0x41,0x00,0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,0x41,
	0x36,0x08,0x00,0x00,0x10,0x08,0x08,0x10,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x20,0x54,0x54,0xd4,0x78,0x00,0x38,0x44,0x46,0x45,0x20,0x00,0x38,0x54,0x54,0xd4,
	0x18,0x00,0x00,0x49,0x7f,0x44,0x00,0x00,0x7c,0x08,0x06,0x05,0x78,0x00,0x38,0x44,
	0x46,0x45,0x38,0x00,0x48,0x54,0x56,0x55,0x20,0x00,0x44,0x64,0x56,0x4d,0x44,0x00,
	0x44,0x64,0x55,0x4c,0x44,0x00,0x7e,0x11,0x11,0x91,0x7e,0x00,0x3c,0x42,0x46,0x43,
	0x24,0x00,0x7f,0x49,0x49,0xc9,0x41,0x00,0x7f,0x50,0x48,0x44,0x40,0x00,0x7e,0x04,
	0x0b,0x10,0x7e,0x00,0x3c,0x42,0x46,0x43,0x3c,0x00,0x4c,0x52,0x56,0x53,0x22,0x00,
	0x42,0x66,0x53,0x4a,0x46,0x00,0x42,0x62,0x53,0x4a,0x46,0x00
};

void lcd_write(uint8_t cd, uint8_t data) {
	LCD_CE_CLR;
	if(cd) LCD_DC_SET; else LCD_DC_CLR;

	for(uint8_t m=0x80; m; m>>=1)
	{
		if(data & m)
		LCD_DATA_SET;
		else
		LCD_DATA_CLR;
		
		LCD_CLK_SET;
		LCD_NOP;
		LCD_CLK_CLR;
	}
	LCD_CE_SET;
}

void lcd_init(void)
{
	LCD_CLK_SET_OUT;
	LCD_DATA_SET_OUT;
	LCD_DC_SET_OUT;
	LCD_CE_SET_OUT;

	//   < 30ms
	_delay_ms(15);

	LCD_CE_SET;

	lcd_write(LCD_CMD, 0x21); // Function set - extended instruction set
	lcd_write(LCD_CMD, 0x13); // Bias - 1:48
	lcd_write(LCD_CMD, 0x06); // Temperature Control
	lcd_write(LCD_CMD, 0xa5); // Set Vop
	lcd_write(LCD_CMD, 0x20); // Function set - basic instruction set, horizontal addressing
	lcd_write(LCD_CMD, 0x0C); // Display control - normal mode
}

void lcd_clear(void)
{
	uint8_t i,j;
	
	for(i=0,j=0; i<6; i++)
	{
		for(j=0; j<84 ; j++)
		lcd_buf[j][i] = 0;
	}
}

void lcd_text(char s[], uint8_t x, uint8_t y)
{
	uint16_t c,j;
	uint8_t i,k;

	// Kody polskich literek z ogonkami
	char pl[] = {'¹','æ','ê','³','ñ','ó','œ','Ÿ','¿','¥','Æ','Ê','£','Ñ','Ó','Œ','','¯'};
	
	// Ustawia po³o¿enia pierwszej litery tekstu na ekranie LCD
	//lcd_write(LCD_CMD, LCD_SETY|(y));
	//lcd_write(LCD_CMD, LCD_SETX|(x));

	// Rysuje znak po znaku
	for(k=0; (c = s[k]); k++)
	{
		// Dopasowuje kody znaków z ogonkami
		for(i=0; (i<18) && (pl[i]!=c); i++) ;
		if(i<18) c= 0x80+i;

		// Kopiuje jeden znak(6x8) z FLASH do pamiêci obrazu LCD
		for(i=0, j=(c-32)*6; i<6; i++,j++)
		//lcd_write(LCD_DATA, pgm_read_byte(&font[j]));
		lcd_buf[x + (k * 6) + i][y] = pgm_read_byte(&font[j]);
	}
}

void lcd_image(const uint8_t img[],uint8_t  x, uint8_t y, uint8_t w, uint8_t h)
{
	uint16_t i,j,k;
	
	for(i=0,j=0,k=0; i<h; i++)
	{
		// Ustawia po³o¿enia lewego górnego robu obrazka na ekranie LCD
		//lcd_write(LCD_CMD, LCD_SETY|(i+y));
		//lcd_write(LCD_CMD, LCD_SETX|(x));

		// Kopiuje dane obrazka z FLASH do pamiêci obrazu LCD
		for(j=0; j<w ; j++,k++)
		//lcd_write(LCD_DATA, pgm_read_byte(&img[k]));
		lcd_buf[x+j][y+i] = pgm_read_byte(&img[k]);
	}
}

void lcd_refresh(void) {
	uint8_t i,j;
	
	for(i=0,j=0; i<6; i++)
	{
		lcd_write(LCD_CMD, 0x40|i);
		lcd_write(LCD_CMD, 0x80);

		for(j=0; j<84; j++)
		lcd_write(LCD_DATA, lcd_buf[j][i]);
	}
}